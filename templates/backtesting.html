{% extends "base.html" %}

{% block title %}Backtesting - Sports Forecasting PRO{% endblock %}

{% block styles %}
<style>
.stat-card {
    transition: all 0.3s ease;
    border-radius: 15px;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.positive {
    color: #28a745;
    font-weight: bold;
}

.negative {
    color: #dc3545;
    font-weight: bold;
}

.market-badge {
    font-size: 0.9rem;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
    transition: all 0.2s ease;
}

.badge-win {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.badge-loss {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
}

.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 40px 0;
    margin-bottom: 30px;
    border-radius: 0 0 20px 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="text-white mb-0">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Backtesting & Análisis Histórico
                </h1>
                <p class="text-white-50 mb-0 mt-2">
                    Rendimiento histórico y métricas de todas las estrategias
                </p>
            </div>
            <div class="col-lg-4 text-right">
                <a href="/" class="btn btn-light btn-lg">
                    <i class="fas fa-home mr-2"></i> Volver al Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    {% if stats %}
    <!-- KPIs Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-0 shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">
                                Total Apuestas
                            </p>
                            <h3 class="mb-0">{{ stats.total_bets }}</h3>
                        </div>
                        <div class="col-auto">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                <i class="fas fa-ticket-alt text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-0 shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">
                                ROI Global
                            </p>
                            <h3 class="mb-0 {% if stats.roi > 0 %}positive{% else %}negative{% endif %}">
                                {{ "%.2f"|format(stats.roi) }}%
                            </h3>
                        </div>
                        <div class="col-auto">
                            <div class="stat-icon" style="background: {% if stats.roi > 0 %}linear-gradient(135deg, #28a745, #20c997){% else %}linear-gradient(135deg, #dc3545, #fd7e14){% endif %};">
                                <i class="fas fa-percentage text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-0 shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">
                                PNL Total
                            </p>
                            <h3 class="mb-0 {% if stats.pnl > 0 %}positive{% else %}negative{% endif %}">
                                {{ "%.2f"|format(stats.pnl) }} u
                            </h3>
                        </div>
                        <div class="col-auto">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                <i class="fas fa-coins text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-0 shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">
                                Hit Rate
                            </p>
                            <h3 class="mb-0" style="color: #5e72e4;">
                                {{ "%.1f"|format(stats.hit_rate) }}%
                            </h3>
                        </div>
                        <div class="col-auto">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #5e72e4, #825ee4);">
                                <i class="fas fa-bullseye text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rendimiento por Mercado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-0">
                <div class="card-header bg-gradient-primary">
                    <h3 class="mb-0 text-white">
                        <i class="fas fa-chart-pie mr-2"></i>
                        Rendimiento por Mercado
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-items-center">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Mercado</th>
                                    <th scope="col" class="text-right">Apuestas</th>
                                    <th scope="col" class="text-right">Turnover</th>
                                    <th scope="col" class="text-right">PNL</th>
                                    <th scope="col" class="text-right">ROI</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for market in by_market %}
                                <tr>
                                    <td>
                                        <span class="market-badge badge 
                                            {% if market.Mercado == 'AH' %}badge-info
                                            {% elif market.Mercado == '1X2' %}badge-primary
                                            {% else %}badge-warning{% endif %}">
                                            {{ market.Mercado }}
                                        </span>
                                    </td>
                                    <td class="text-right font-weight-bold">{{ market.Apuestas }}</td>
                                    <td class="text-right">{{ "%.2f"|format(market.Turnover) }} u</td>
                                    <td class="text-right {% if market.PNL > 0 %}positive{% else %}negative{% endif %}">
                                        {{ "%.2f"|format(market.PNL) }} u
                                    </td>
                                    <td class="text-right {% if market.ROI > 0 %}positive{% else %}negative{% endif %}">
                                        {{ "%.2f"|format(market.ROI) }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Últimas Apuestas -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow border-0">
                <div class="card-header bg-gradient-info">
                    <h3 class="mb-0 text-white">
                        <i class="fas fa-history mr-2"></i>
                        Últimas 20 Apuestas
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-items-center">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Fecha</th>
                                    <th scope="col">Mercado</th>
                                    <th scope="col">Apuesta</th>
                                    <th scope="col" class="text-right">Odds</th>
                                    <th scope="col" class="text-right">Stake</th>
                                    <th scope="col" class="text-right">PNL</th>
                                    <th scope="col" class="text-center">Resultado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bet in recent_bets %}
                                <tr>
                                    <td>
                                        <small class="text-muted">
                                            {{ bet.date if bet.date else 'N/A' }}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge badge-sm 
                                            {% if bet.market == 'AH' %}badge-info
                                            {% elif bet.market == '1X2' %}badge-primary
                                            {% else %}badge-warning{% endif %}">
                                            {{ bet.market }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ bet.bet_type if bet.bet_type else 'N/A' }}</small>
                                    </td>
                                    <td class="text-right">{{ "%.2f"|format(bet.odds) if bet.odds else 'N/A' }}</td>
                                    <td class="text-right">{{ "%.2f"|format(bet.stake) if bet.stake else 'N/A' }}</td>
                                    <td class="text-right {% if bet.pnl > 0 %}positive{% else %}negative{% endif %}">
                                        {{ "%.2f"|format(bet.pnl) if bet.pnl else 'N/A' }}
                                    </td>
                                    <td class="text-center">
                                        {% if bet.result == 'WIN' %}
                                        <span class="badge badge-win">
                                            <i class="fas fa-check mr-1"></i> WIN
                                        </span>
                                        {% else %}
                                        <span class="badge badge-loss">
                                            <i class="fas fa-times mr-1"></i> LOSS
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Sin Datos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow border-0">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-line text-muted mb-4" style="font-size: 64px;"></i>
                    <h3 class="text-muted">No hay datos de backtesting disponibles</h3>
                    <p class="text-muted mb-4">
                        Ejecuta un backtest primero para ver los resultados aquí
                    </p>
                    <div class="alert alert-info d-inline-block">
                        <i class="fas fa-terminal mr-2"></i>
                        <code>python scripts/backtest_all_markets_fixed.py</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Backtesting page loaded');
    
    // Animar las tarjetas al cargar
    const cards = document.querySelectorAll('.stat-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}

